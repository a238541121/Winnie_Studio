<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <img src="https://drive.google.com/thumbnail?id=1JWsYM27l4WR4x9b4Qfk1d7BiZ6Jidgz2" alt="Google Drive Image" class="background-image">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç¾ç”²ï¼†ç«æ¯›ç®¡ç†é ç´„è¡¨å–®</title>
    <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <style>
        body {
            /* background: url('https://drive.google.com/uc?export=view&id=1JWsYM27l4WR4x9b4Qfk1d7BiZ6Jidgz2'); */
            /* background-size: cover;
            background-position: center;
            background-repeat: no-repeat; */
            font-family: Arial, sans-serif;
        }
        .background-image {
            position: fixed; /* å›ºå®šèƒŒæ™¯ */
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover; /* è®“åœ–ç‰‡å¡«æ»¿ç•«é¢ */
            z-index: -1; /* è¨­å®šèƒŒæ™¯å±¤ */
            filter: blur(8px); /* åŠ ä¸Šæ¨¡ç³Šæ•ˆæœ */
        }
        .container {
            background: rgba(249, 214, 174, 0.195);
            padding: 80px;
            border-radius: 10px;
            margin-top: 50px;
        }
        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            margin: auto;
            animation: spin 2s linear infinite;
        }
        /* éŒ¯èª¤è¨Šæ¯å®¹å™¨ */
        .errContainer {
            position: absolute; /* è®“å®ƒèƒ½å¤ ç›¸å°æ–¼è¦–çª—å®šä½ */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* å®Œå…¨ç½®ä¸­ */
            display: flex;
            flex-direction: column;  /* è®“å…§å®¹ä¸Šä¸‹æ’åˆ— */
            align-items: center;
            text-align: center;
            background: rgba(244, 214, 171, 0.4);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            width: 320px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
        }
        
        /* è¨Šæ¯æ¨™ç±¤ */
        .form-errorMessage {
            font-size: 18px;
            color: #d9534f; /* ç´…è‰²éŒ¯èª¤è¨Šæ¯ */
            font-weight: bold;
            margin-bottom: 10px;
            flex-basis: 100%; /* è®“éŒ¯èª¤è¨Šæ¯ä½”æ»¿ä¸€æ•´è¡Œ */
        }
        
        /* é‡æ–°è¼‰å…¥æŒ‰éˆ• */
        .btn-reloadPage {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.3s, transform 0.2s;
        }
        
        .btn-reloadPage:hover {
            background-color: #0056b3;
        }
        
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader"></div>
    <div class="container" id="content" style="display: none;">
        <h2 class="text-center">å¡«å¯«é ç´„</h2>
        <form id="bookingForm">
            <div class="mb-3">
                <label for="name" class="form-label">å§“å</label>
                <input type="text" class="form-control" id="name" required />
            </div>
            <div class="mb-3">
                <label for="phone" class="form-label">é›»è©±</label>
                <input type="tel" class="form-control" id="phone" required />
            </div>
            <div class="mb-3">
                <label for="timeslot" class="form-label">æ™‚æ®µ</label>
                <select class="form-select" id="timeslot">
                    <option value="">è«‹é¸æ“‡æ™‚æ®µ</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="item" class="form-label d-block">é …ç›®</label>
                <select id="item" class="form-select" onchange="toggleItem()">
                    <option value="æ‰‹è¶³">æ‰‹è¶³</option>
                    <option value="æ‰‹">æ‰‹</option>
                    <option value="è¶³">è¶³</option>
                    <option value="ä¸Šç«æ¯›">ä¸Šç«æ¯›</option>
                    <option value="ä¸Šä¸‹ç«æ¯›">ä¸Šä¸‹ç«æ¯›</option>
                </select>
            </div>
            <div class="mb-3" id="nailNumField">
                <label for="nailNum" class="form-label">éœ€å»¶ç”²å¹¾æŒ‡</label>
                <input
                type="number"
                class="form-control"
                id="nailNum"
                value="0"
                min="0"
                max="20"
                />
            </div>
            <div class="mb-3">
                <label for="remarks" class="form-label">å‚™è¨»</label>
                <textarea class="form-control" id="remarks" required></textarea>
            </div>
            <button type="button" class="btn btn-primary w-100" onclick="sendSubmit()">é€å‡ºé ç´„</button>
        </form>
    </div>
    <div class="errContainer" id="errContainer" style="display: none;">
        <label for="errorMessage" class="form-errorMessage">è«‹é‡æ–°é–‹å•Ÿï¼</label>
        <button id="reloadPage" class="btn-reloadPage" onclick="reloadPage()">é‡æ–°è¼‰å…¥</button>
    </div>
    <script>
        let cloudflareUrl = "https://workerwinnie.a238541121.workers.dev/";
        // å–å¾—ä¸¦é¡¯ç¤º lineId
        async function sendSubmit() {
            var data = {
                lineId: sessionStorage.getItem("lineId"),
                name: document.getElementById("name").value.trim() || null,
                phone: document.getElementById("phone").value.trim() || null,
                timeslot: document.getElementById("timeslot").value || null,
                item: document.getElementById("item").value || null,
                nailNum:
                document.getElementById("nailNum").value !== ""
                ? Number(document.getElementById("nailNum").value)
                : null,
                remarks: document.getElementById("remarks").value.trim() || "",
            };
            let confirmresult = await Swal.fire({
                title: "è«‹ç¢ºèªæ‚¨çš„é ç´„è³‡æ–™",
                html: `
                    <p><strong>å§“å:</strong> ${data.name}</p>
                    <p><strong>é›»è©±:</strong> ${data.phone}</p>
                    <p><strong>æ™‚æ®µ:</strong> ${data.timeslot}</p>
                    <p><strong>é …ç›®:</strong> ${data.item}</p>
                    ${
                data.item === "ä¸Šç«æ¯›" || data.item === "ä¸Šä¸‹ç«æ¯›"
                ? ""
                : `<p><strong>éœ€å»¶ç”²å¹¾æŒ‡:</strong> ${data.nailNum}</p>`
                }
                    <p><strong>å‚™è¨»:</strong> ${data.remarks}</p>
                `,
                icon: "info",
                showCancelButton: true,
                confirmButtonText: "é€å‡º",
                cancelButtonText: "å–æ¶ˆ",
                preConfirm: () => {
                    let nailNumValue = document.getElementById("nailNum")?.value || "0";
                    if (isNaN(nailNumValue) || nailNumValue < 0 || nailNumValue > 20) {
                        Swal.showValidationMessage("è«‹è¼¸å…¥ 0-20 ä¹‹é–“çš„æ•¸å­—");
                        return false;
                    }
                    return { nailNum: parseInt(nailNumValue, 10) };
                },
            });
            if (!confirmresult.isConfirmed) {
                return;
            } else {
                // data.nailNum = confirmresult.value.nailNum;
                try {
                    let response = await fetch(`${cloudflareUrl}`, {
                        method: "POST",
                        body: JSON.stringify(data),
                        headers: { "Content-Type": "application/json" },
                    });
                    if (response.ok) {
                        let result = JSON.parse(await response.text()); // è§£æè¿”å›çš„ JSON
                        console.log(result); // è™•ç†çµæœ
                        if (result.isSuc === false) {
                            let confirm_appointFai = await Swal.fire({
                                title: "é ç´„å¤±æ•—",
                                text: `${result.retFaiReason}`,
                                icon: "error",
                                confirmButtonText: "OK",
                            });
                        } else {
                            let confirm_appointSuc = await Swal.fire({
                                title: "é ç´„æˆåŠŸ",
                                html: `
                                    <p><strong>å§“å:</strong> ${
                                result.retName
                            }</p>
                                    <p><strong>é›»è©±:</strong> ${
                            result.retPhone
                        }</p>
                                    <p><strong>æ™‚æ®µ:</strong> ${
                        result.retTimeSlot
                    }</p>
                                    <p><strong>é …ç›®:</strong> ${
                    result.retItem
                }</p>
                                    ${
                result.retItem === "ä¸Šç«æ¯›" ||
                result.retItem === "ä¸Šä¸‹ç«æ¯›"
                ? ""
                : `<p><strong>éœ€å»¶ç”²å¹¾æŒ‡:</strong> ${result.retNailNum}</p>`
                }
                                    <p><strong>å‚™è¨»:</strong> ${
                result.retRemarks
            }</p>
                                `,
            icon: "success",
            confirmButtonText: "OK",
        });
        if (confirm_appointSuc) window.close();
    }
} else {
    console.error("é ç´„å¤±æ•—:", response.statusText);
    let confirm_Fai = await Swal.fire({
        title: "å‡ºäº†ä¸€é»å•é¡Œ",
        text: `${response.statusText}`,
        icon: "error",
        confirmButtonText: "é‡è©¦",
        cancelButtonText: "å–æ¶ˆ",
    });
    if (confirm_Fai) {
        sendSubmit();
    } else {
        return;
    }
}
} catch (error) {
    console.error("éŒ¯èª¤:", error);
    alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ï¼");
}
}

// alert(document.getElementById("lineId").value + " " + document.getElementById("remarks").value);
// alert(`${data.lineId} è³‡æ–™å·²å„²å­˜ï¼`);
}

async function initLIFF() {
    try {
        const res = await fetch(`${cloudflareUrl}liff-id`);
        const data = JSON.parse(await res.text());
        if (!data.LIFF_ID) {
            throw new Error("æ²’æœ‰è¨­å®š LIFF IDï¼Œå°‡å˜—è©¦å¾ URL è®€å– lineId...");
        }
        
        await liff.init({
            liffId: data.LIFF_ID,
            withLoginOnExternalBrowser: true,
        });
        
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }
        
        const profile = await liff.getProfile();
        sessionStorage.setItem("lineId", profile.userId);
        // document.getElementById("lineId").value = profile.userId;
        await dataSearch(profile.userId);
        
        console.log("LIFF åˆå§‹åŒ–æˆåŠŸ");
    } catch (err) {
        console.warn("LIFF åˆå§‹åŒ–å¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯:", err);
        getLineIdFromURL(); // å¦‚æœ LIFF å¤±æ•—ï¼Œå°±å¾ URL è®€å– lineId
    }
}

async function dataSearch(lineID) {
    var data = {
        lineId: lineID,
        search: "true",
    };
    try {
        let response = await fetch(`${cloudflareUrl}`, {
            method: "POST",
            body: JSON.stringify(data),
            headers: { "Content-Type": "application/json" },
        });
        console.log(response);
        let data1 = JSON.parse(await response.text());
        console.log("å–å¾—çš„è³‡æ–™:", data1.message); // ğŸ”¹ ç¢ºä¿è³‡æ–™æ­£ç¢ºå›å‚³
        
        if (!data1 || !data1.message || !Array.isArray(data1.message)) {
            console.error("éŒ¯èª¤: æ™‚æ®µè³‡æ–™æ ¼å¼éŒ¯èª¤æˆ–ä¸å­˜åœ¨");
            return;
        }
        if (data1.isMember == false) {
            document.getElementById("name").value = "";
            document.getElementById("phone").value = "";
            document.getElementById("name").readOnly = "false";
            document.getElementById("phone").readOnly = "false";
        } else {
            document.getElementById("name").value = data1.name;
            document.getElementById("phone").value = data1.phone;
            document.getElementById("name").readOnly = "true";
            document.getElementById("phone").readOnly = "true";
        }
        let select = document.getElementById("timeslot");
        select.innerHTML = ""; // æ¸…ç©ºèˆŠé¸é …
        
        // ğŸ”¹ å‹•æ…‹åŠ å…¥å¯é ç´„æ™‚æ®µ
        data1.message.forEach((timeSlot) => {
            let option = document.createElement("option");
            option.value = timeSlot;
            option.textContent = timeSlot;
            select.appendChild(option);
        });
        
        // é¡¯ç¤ºç•«é¢
        document.getElementById("content").style.display = "block";
        document.getElementById("errContainer").style.display = "none";
        document.getElementById("loader").style.display = "none";
    } catch (error) {
        console.error("å–å¾—æ™‚æ®µå¤±æ•—", error);
    }
}
async function getLineIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const lineId = urlParams.get("lineId");
    
    if (lineId) {
        document.getElementById("lineId").value = lineId;
        await dataSearch(lineId);
        // é¡¯ç¤ºç•«é¢
        // document.getElementById("content").style.display = "block";
        // document.getElementById("errContainer").style.display = "none";
    } else {
        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
        // document.getElementById("content").style.display = "none";
        // document.getElementById("errContainer").style.display = "block";
    }
}

function reloadPage() {
    location.reload();
}
function toggleItem() {
    var nailNumField = document.getElementById("nailNumField");
    var item = document.getElementById("item").value;
    
    if (item === "ä¸Šç«æ¯›" || item === "ä¸Šä¸‹ç«æ¯›") {
        nailNumField.style.display = "none";
        document.getElementById("nailNum").value = "0";
    } else {
        nailNumField.style.display = "block";
    }
}
// åˆå§‹åŒ– LIFF æˆ–å¾ URL è®€å– lineId
//   window.onload = async () => {

//   };
document.addEventListener("DOMContentLoaded", async function () {
    await initLIFF();
    (".loader-inner").loaders();
});
</script>
</body>
</html>
